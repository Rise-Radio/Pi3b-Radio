

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyPy - The RPython Toolchain &mdash; PyPy 2.2.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PyPy 2.2.0 documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="index.html">PyPy 2.2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pypy-the-rpython-toolchain">
<h1><a class="toc-backref" href="#id10">PyPy - The RPython Toolchain</a><a class="headerlink" href="#pypy-the-rpython-toolchain" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#pypy-the-rpython-toolchain" id="id10">PyPy - The RPython Toolchain</a><ul>
<li><a class="reference internal" href="#overview" id="id11">Overview</a></li>
<li><a class="reference internal" href="#the-flow-model" id="id12">The Flow Model</a></li>
<li><a class="reference internal" href="#the-annotation-pass" id="id13">The Annotation Pass</a><ul>
<li><a class="reference internal" href="#mutable-values-and-containers" id="id14">Mutable Values and Containers</a></li>
<li><a class="reference internal" href="#user-defined-classes-and-instances" id="id15">User-defined Classes and Instances</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-rpython-typer" id="id16">The RPython Typer</a><ul>
<li><a class="reference internal" href="#example-integer-operations" id="id17">Example: Integer operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-optional-transformations" id="id18">The Optional Transformations</a><ul>
<li><a class="reference internal" href="#backend-optimizations" id="id19">Backend Optimizations</a><ul>
<li><a class="reference internal" href="#function-inlining" id="id20">Function Inlining</a></li>
<li><a class="reference internal" href="#malloc-removal" id="id21">Malloc Removal</a></li>
<li><a class="reference internal" href="#escape-analysis-and-stack-allocation" id="id22">Escape Analysis and Stack Allocation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-stackless-transform" id="id23">The Stackless Transform</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preparation-for-source-generation" id="id24">Preparation for Source Generation</a><ul>
<li><a class="reference internal" href="#making-exception-handling-explicit" id="id25">Making Exception Handling Explicit</a></li>
<li><a class="reference internal" href="#memory-management-details" id="id26">Memory Management Details</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-c-back-end" id="id27">The C Back-End</a></li>
<li><a class="reference internal" href="#a-historical-note" id="id28">A Historical Note</a></li>
<li><a class="reference internal" href="#other-backends" id="id29">Other backends</a></li>
<li><a class="reference internal" href="#external-function-calls" id="id30">External Function Calls</a></li>
<li><a class="reference internal" href="#how-it-fits-together" id="id31">How It Fits Together</a></li>
</ul>
</li>
</ul>
</div>
<p>This document describes the toolchain that we have developed to analyze
and &#8220;compile&#8221; <a class="reference external" href="coding-guide.html#restricted-python">RPython</a> programs (like PyPy itself) to various target
platforms.</p>
<p>It consists of three broad sections: a slightly simplified overview, a
brief introduction to each of the major components of our toolchain and
then a more comprehensive section describing how the pieces fit together.
If you are reading this document for the first time, the <a class="reference internal" href="#overview">Overview</a> is
likely to be most useful, if you are trying to refresh your PyPy memory
then the <a class="reference internal" href="#how-it-fits-together">How It Fits Together</a> is probably what you want.</p>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id11">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The job of the translation toolchain is to translate <a class="reference external" href="coding-guide.html#restricted-python">RPython</a> programs into an
efficient version of that program for one of various target platforms,
generally one that is considerably lower-level than Python.  It divides
this task into several steps, and the purpose of this document is to
introduce them.</p>
<p>To start with we describe the process of translating an <a class="reference external" href="coding-guide.html#restricted-python">RPython</a> program into
C (which is the default and original target).</p>
<p id="initialization-time">The RPython translation toolchain never sees Python source code or syntax
trees, but rather starts with the <em>code objects</em> that define the
behaviour of the function objects one gives it as input.  The
<a class="reference external" href="interpreter.html">bytecode evaluator</a> and the <a class="reference external" href="objspace.html#the-flow-object-space">Flow Object Space</a> work through these
code objects using <a class="reference external" href="http://en.wikipedia.org/wiki/Abstract_interpretation">abstract interpretation</a> to produce a control
flow graph (one per function): yet another representation of the
source program, but one which is suitable for applying type inference
and translation techniques and which is the fundamental data structure
most of the translation steps operate on.</p>
<p>It is helpful to consider translation as being made up of the following
steps (see also the figure below):</p>
<ol class="arabic simple">
<li>The complete program is imported, at which time arbitrary run-time
initialization can be performed.  Once this is done, the program must
be present in memory as a form that is &#8220;static enough&#8221; in the sense of
<a class="reference external" href="coding-guide.html#restricted-python">RPython</a>.</li>
<li>The <a class="reference internal" href="#annotator">Annotator</a> performs a global analysis starting from an specified
entry point to deduce type and other information about what each
variable can contain at run-time, building flow graphs using the <a class="reference external" href="objspace.html#the-flow-object-space">Flow
Object Space</a> as it encounters them.</li>
<li>The <a class="reference internal" href="#rpython-typer">RPython Typer</a> (or RTyper) uses the high-level information
inferred by the Annotator to turn the operations in the control flow
graphs into low-level operations.</li>
<li>After RTyping there are two, rather different, <a class="reference internal" href="#optional-transformations">optional
transformations</a> which can be applied &#8211; the &#8220;backend
optimizations&#8221; which are intended to make the resulting program go
faster, and the &#8220;stackless transform&#8221; which transforms the program
into a form of continuation passing style which allows the
implementation of coroutines and other forms of non-standard
control flow.</li>
<li>The next step is <a class="reference internal" href="#preparing-the-graphs-for-source-generation">preparing the graphs for source generation</a>, which
involves computing the names that the various functions and types in
the program will have in the final source and applying transformations
which insert explicit exception handling and memory management
operations.</li>
<li>The <a class="reference internal" href="#c-backend">C backend</a> (colloquially known as &#8220;GenC&#8221;) produces a number of C
source files (as noted above, we are ignoring the other backends for
now).</li>
<li>These source files are compiled to produce an executable.</li>
</ol>
<p>(although these steps are not quite as distinct as you might think from
this presentation).</p>
<p>There is an <a class="reference external" href="getting-started-dev.html#try-out-the-translator">interactive interface</a> called <a class="reference external" href="https://bitbucket.org/pypy/pypy/src/default/rpython/bin/translatorshell.py">rpython/bin/translatorshell.py</a> to the
translation process which allows you to interactively work through these
stages.</p>
<p>The following figure gives a simplified overview (<a class="reference external" href="https://bitbucket.org/pypy/pypy/raw/default/pypy/doc/image/translation.pdf">PDF color version</a>):</p>
<blockquote>
<div><img alt="_images/translation-greyscale-small.png" src="_images/translation-greyscale-small.png" />
</div></blockquote>
</div>
<div class="section" id="the-flow-model">
<span id="control-flow-graphs"></span><span id="flow-model"></span><h2><a class="toc-backref" href="#id12">The Flow Model</a><a class="headerlink" href="#the-flow-model" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="objspace.html#the-flow-object-space">Flow Object Space</a> is described in the <a class="reference external" href="objspace.html">document
describing object spaces</a>. Here we describe the data structures produced by it,
which are the basic data structures of the translation
process.</p>
<p>All these types are defined in <a class="reference external" href="https://bitbucket.org/pypy/pypy/src/default/rpython/flowspace/model.py">rpython/flowspace/model.py</a> (which is a rather
important module in the PyPy source base, to reinforce the point).</p>
<p>The flow graph of a function is represented by the class <tt class="docutils literal"><span class="pre">FunctionGraph</span></tt>.
It contains a reference to a collection of <tt class="docutils literal"><span class="pre">Block</span></tt>s connected by <tt class="docutils literal"><span class="pre">Link</span></tt>s.</p>
<p>A <tt class="docutils literal"><span class="pre">Block</span></tt> contains a list of <tt class="docutils literal"><span class="pre">SpaceOperation</span></tt>s.  Each <tt class="docutils literal"><span class="pre">SpaceOperation</span></tt>
has an <tt class="docutils literal"><span class="pre">opname</span></tt> and a list of <tt class="docutils literal"><span class="pre">args</span></tt> and <tt class="docutils literal"><span class="pre">result</span></tt>, which are either
<tt class="docutils literal"><span class="pre">Variable</span></tt>s or <tt class="docutils literal"><span class="pre">Constant</span></tt>s.</p>
<p>We have an extremely useful PyGame viewer, which allows you to visually
inspect the graphs at various stages of the translation process (very
useful to try to work out why things are breaking).  It looks like this:</p>
<blockquote>
<div><img alt="_images/bpnn_update.png" src="_images/bpnn_update.png" />
</div></blockquote>
<p>It is recommended to play with <tt class="docutils literal"><span class="pre">python</span> <span class="pre">bin/translatorshell.py</span></tt> on a few
examples to get an idea of the structure of flow graphs. The following describes
the types and their attributes in some detail:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">FunctionGraph</span></tt></dt>
<dd><p class="first">A container for one graph (corresponding to one function).</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">startblock:</th><td class="field-body">the first block.  It is where the control goes when the
function is called.  The input arguments of the startblock
are the function&#8217;s arguments.  If the function takes a
<tt class="docutils literal"><span class="pre">*args</span></tt> argument, the <tt class="docutils literal"><span class="pre">args</span></tt> tuple is given as the last
input argument of the startblock.</td>
</tr>
<tr class="field-even field"><th class="field-name">returnblock:</th><td class="field-body">the (unique) block that performs a function return.  It is
empty, not actually containing any <tt class="docutils literal"><span class="pre">return</span></tt> operation; the
return is implicit.  The returned value is the unique input
variable of the returnblock.</td>
</tr>
<tr class="field-odd field"><th class="field-name">exceptblock:</th><td class="field-body">the (unique) block that raises an exception out of the
function.  The two input variables are the exception class
and the exception value, respectively.  (No other block will
actually link to the exceptblock if the function does not
explicitly raise exceptions.)</td>
</tr>
</tbody>
</table>
</dd>
<dt><tt class="docutils literal"><span class="pre">Block</span></tt></dt>
<dd><p class="first">A basic block, containing a list of operations and ending in jumps to other
basic blocks.  All the values that are &#8220;live&#8221; during the execution of the
block are stored in Variables.  Each basic block uses its own distinct
Variables.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">inputargs:</th><td class="field-body">list of fresh, distinct Variables that represent all the
values that can enter this block from any of the previous
blocks.</td>
</tr>
<tr class="field-even field"><th class="field-name">operations:</th><td class="field-body">list of SpaceOperations.</td>
</tr>
<tr class="field-odd field"><th class="field-name">exitswitch:</th><td class="field-body">see below</td>
</tr>
<tr class="field-even field"><th class="field-name">exits:</th><td class="field-body">list of Links representing possible jumps from the end of this
basic block to the beginning of other basic blocks.</td>
</tr>
</tbody>
</table>
<p>Each Block ends in one of the following ways:</p>
<ul class="last simple">
<li>unconditional jump: exitswitch is None, exits contains a single Link.</li>
<li>conditional jump: exitswitch is one of the Variables that appear in the
Block, and exits contains one or more Links (usually 2).  Each Link&#8217;s
exitcase gives a concrete value.  This is the equivalent of a &#8220;switch&#8221;:
the control follows the Link whose exitcase matches the run-time value of
the exitswitch Variable.  It is a run-time error if the Variable doesn&#8217;t
match any exitcase.</li>
<li>exception catching: exitswitch is <tt class="docutils literal"><span class="pre">Constant(last_exception)</span></tt>.  The first
Link has exitcase set to None and represents the non-exceptional path.
The next Links have exitcase set to a subclass of Exception, and are taken
when the <em>last</em> operation of the basic block raises a matching exception.
(Thus the basic block must not be empty, and only the last operation is
protected by the handler.)</li>
<li>return or except: the returnblock and the exceptblock have operations set
to an empty tuple, exitswitch to None, and exits empty.</li>
</ul>
</dd>
<dt><tt class="docutils literal"><span class="pre">Link</span></tt></dt>
<dd><p class="first">A link from one basic block to another.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">prevblock:</th><td class="field-body">the Block that this Link is an exit of.</td>
</tr>
<tr class="field-even field"><th class="field-name">target:</th><td class="field-body">the target Block to which this Link points to.</td>
</tr>
<tr class="field-odd field"><th class="field-name">args:</th><td class="field-body">a list of Variables and Constants, of the same size as the
target Block&#8217;s inputargs, which gives all the values passed
into the next block.  (Note that each Variable used in the
prevblock may appear zero, one or more times in the <tt class="docutils literal"><span class="pre">args</span></tt>
list.)</td>
</tr>
<tr class="field-even field"><th class="field-name">exitcase:</th><td class="field-body">see above.</td>
</tr>
<tr class="field-odd field"><th class="field-name">last_exception:</th><td class="field-body">None or a Variable; see below.</td>
</tr>
<tr class="field-even field"><th class="field-name">last_exc_value:</th><td class="field-body">None or a Variable; see below.</td>
</tr>
</tbody>
</table>
<p>Note that <tt class="docutils literal"><span class="pre">args</span></tt> uses Variables from the prevblock, which are matched to
the target block&#8217;s <tt class="docutils literal"><span class="pre">inputargs</span></tt> by position, as in a tuple assignment or
function call would do.</p>
<p class="last">If the link is an exception-catching one, the <tt class="docutils literal"><span class="pre">last_exception</span></tt> and
<tt class="docutils literal"><span class="pre">last_exc_value</span></tt> are set to two fresh Variables that are considered to be
created when the link is entered; at run-time, they will hold the exception
class and value, respectively.  These two new variables can only be used in
the same link&#8217;s <tt class="docutils literal"><span class="pre">args</span></tt> list, to be passed to the next block (as usual,
they may actually not appear at all, or appear several times in <tt class="docutils literal"><span class="pre">args</span></tt>).</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">SpaceOperation</span></tt></dt>
<dd><p class="first">A recorded (or otherwise generated) basic operation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">opname:</th><td class="field-body">the name of the operation. The Flow Space produces only operations
from the list in <tt class="docutils literal"><span class="pre">pypy.interpreter.baseobjspace</span></tt>, but later the
names can be changed arbitrarily.</td>
</tr>
<tr class="field-even field"><th class="field-name">args:</th><td class="field-body">list of arguments.  Each one is a Constant or a Variable seen
previously in the basic block.</td>
</tr>
<tr class="field-odd field"><th class="field-name">result:</th><td class="field-body">a <em>new</em> Variable into which the result is to be stored.</td>
</tr>
</tbody>
</table>
<p class="last">Note that operations usually cannot implicitly raise exceptions at run-time;
so for example, code generators can assume that a <tt class="docutils literal"><span class="pre">getitem</span></tt> operation on a
list is safe and can be performed without bound checking.  The exceptions to
this rule are: (1) if the operation is the last in the block, which ends
with <tt class="docutils literal"><span class="pre">exitswitch</span> <span class="pre">==</span> <span class="pre">Constant(last_exception)</span></tt>, then the implicit
exceptions must be checked for, generated, and caught appropriately; (2)
calls to other functions, as per <tt class="docutils literal"><span class="pre">simple_call</span></tt> or <tt class="docutils literal"><span class="pre">call_args</span></tt>, can
always raise whatever the called function can raise &#8212; and such exceptions
must be passed through to the parent unless they are caught as above.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Variable</span></tt></dt>
<dd><p class="first">A placeholder for a run-time value.  There is mostly debugging stuff here.</p>
<table class="last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">name:</th><td class="field-body">it is good style to use the Variable object itself instead of its
<tt class="docutils literal"><span class="pre">name</span></tt> attribute to reference a value, although the <tt class="docutils literal"><span class="pre">name</span></tt> is
guaranteed unique.</td>
</tr>
</tbody>
</table>
</dd>
<dt><tt class="docutils literal"><span class="pre">Constant</span></tt></dt>
<dd><p class="first">A constant value used as argument to a SpaceOperation, or as value to pass
across a Link to initialize an input Variable in the target Block.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">value:</th><td class="field-body">the concrete value represented by this Constant.</td>
</tr>
<tr class="field-even field"><th class="field-name">key:</th><td class="field-body">a hashable object representing the value.</td>
</tr>
</tbody>
</table>
<p class="last">A Constant can occasionally store a mutable Python object.  It represents a
static, pre-initialized, read-only version of that object.  The flow graph
should not attempt to actually mutate such Constants.</p>
</dd>
</dl>
</div>
<div class="section" id="the-annotation-pass">
<span id="annotator"></span><h2><a class="toc-backref" href="#id13">The Annotation Pass</a><a class="headerlink" href="#the-annotation-pass" title="Permalink to this headline">¶</a></h2>
<p>We describe briefly below how a control flow graph can be &#8220;annotated&#8221; to
discover the types of the objects.  This annotation pass is a form of type
inference.  It operates on the control flow graphs built by the Flow
Object Space.</p>
<p>For a more comprehensive description of the annotation process, see the
corresponding section of our <a class="reference external" href="https://bitbucket.org/pypy/extradoc/raw/tip/eu-report/D05.1_Publish_on_translating_a_very-high-level_description.pdf">EU report about translation</a>.</p>
<p>The major goal of the annotator is to &#8220;annotate&#8221; each variable that
appears in a flow graph.  An &#8220;annotation&#8221; describes all the possible
Python objects that this variable could contain at run-time, based on a
whole-program analysis of all the flow graphs &#8211; one per function.</p>
<p>An &#8220;annotation&#8221; is an instance of a subclass of <tt class="docutils literal"><span class="pre">SomeObject</span></tt>.  Each
subclass that represents a specific family of objects.</p>
<p>Here is an overview (see <tt class="docutils literal"><span class="pre">pypy/annotation/model/</span></tt>):</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">SomeObject</span></tt> is the base class.  An instance of <tt class="docutils literal"><span class="pre">SomeObject()</span></tt>
represents any Python object, and as such usually means that the input
program was not fully RPython.</li>
<li><tt class="docutils literal"><span class="pre">SomeInteger()</span></tt> represents any integer.  <tt class="docutils literal"><span class="pre">SomeInteger(nonneg=True)</span></tt>
represent a non-negative integer (<tt class="docutils literal"><span class="pre">&gt;=0</span></tt>).</li>
<li><tt class="docutils literal"><span class="pre">SomeString()</span></tt> represents any string; <tt class="docutils literal"><span class="pre">SomeChar()</span></tt> a string of
length 1.</li>
<li><tt class="docutils literal"><span class="pre">SomeTuple([s1,s2,..,sn])</span></tt> represents a tuple of length <tt class="docutils literal"><span class="pre">n</span></tt>.  The
elements in this tuple are themselves constrained by the given list of
annotations.  For example, <tt class="docutils literal"><span class="pre">SomeTuple([SomeInteger(),</span> <span class="pre">SomeString()])</span></tt>
represents a tuple with two items: an integer and a string.</li>
</ul>
<p>The result of the annotation pass is essentially a large dictionary
mapping <tt class="docutils literal"><span class="pre">Variable</span></tt>s to annotations.</p>
<p>All the <tt class="docutils literal"><span class="pre">SomeXxx</span></tt> instances are immutable.  If the annotator needs to
revise its belief about what a Variable can contain, it does so creating a
new annotation, not mutating the existing one.</p>
<div class="section" id="mutable-values-and-containers">
<h3><a class="toc-backref" href="#id14">Mutable Values and Containers</a><a class="headerlink" href="#mutable-values-and-containers" title="Permalink to this headline">¶</a></h3>
<p>Mutable objects need special treatment during annotation, because
the annotation of contained values needs to be possibly updated to account
for mutation operations, and consequently the annotation information
reflown through the relevant parts of the flow graphs.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">SomeList</span></tt> stands for a list of homogeneous type (i.e. all the
elements of the list are represented by a single common <tt class="docutils literal"><span class="pre">SomeXxx</span></tt>
annotation).</li>
<li><tt class="docutils literal"><span class="pre">SomeDict</span></tt> stands for a homogeneous dictionary (i.e. all keys have
the same <tt class="docutils literal"><span class="pre">SomeXxx</span></tt> annotation, and so have all values).</li>
</ul>
</div>
<div class="section" id="user-defined-classes-and-instances">
<h3><a class="toc-backref" href="#id15">User-defined Classes and Instances</a><a class="headerlink" href="#user-defined-classes-and-instances" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">SomeInstance</span></tt> stands for an instance of the given class or any
subclass of it.  For each user-defined class seen by the annotator, we
maintain a ClassDef (<tt class="docutils literal"><span class="pre">pypy.annotation.classdef</span></tt>) describing the
attributes of the instances of the class; essentially, a ClassDef gives
the set of all class-level and instance-level attributes, and for each
one, a corresponding <tt class="docutils literal"><span class="pre">SomeXxx</span></tt> annotation.</p>
<p>Instance-level attributes are discovered progressively as the annotation
progresses.  Assignments like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">inst</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>
</div>
<p>update the ClassDef of the given instance to record that the given
attribute exists and can be as general as the given value.</p>
<p>For every attribute, the ClassDef also records all the positions where
the attribute is <em>read</em>.  If, at some later time, we discover an
assignment that forces the annotation about the attribute to be
generalized, then all the places that read the attribute so far are
marked as invalid and the annotator will restart its analysis
from there.</p>
<p>The distinction between instance-level and class-level attributes is
thin; class-level attributes are essentially considered as initial
values for instance-level attributes.  Methods are not special in this
respect, except that they are bound to the instance (i.e. <tt class="docutils literal"><span class="pre">self</span> <span class="pre">=</span>
<span class="pre">SomeInstance(cls)</span></tt>) when considered as the initial value for the
instance.</p>
<p>The inheritance rules are as follows: the union of two <tt class="docutils literal"><span class="pre">SomeInstance</span></tt>
annotations is the <tt class="docutils literal"><span class="pre">SomeInstance</span></tt> of the most precise common base
class.  If an attribute is considered (i.e. read or written) through a
<tt class="docutils literal"><span class="pre">SomeInstance</span></tt> of a parent class, then we assume that all subclasses
also have the same attribute, and that the same annotation applies to
them all (so code like <tt class="docutils literal"><span class="pre">return</span> <span class="pre">self.x</span></tt> in a method of a parent class
forces the parent class and all its subclasses to have an attribute
<tt class="docutils literal"><span class="pre">x</span></tt>, whose annotation is general enough to contain all the values that
all the subclasses might want to store in <tt class="docutils literal"><span class="pre">x</span></tt>).  However, distinct
subclasses can have attributes of the same names with different,
unrelated annotations if they are not used in a general way through the
parent class.</p>
</div>
</div>
<div class="section" id="the-rpython-typer">
<span id="rpython-typer"></span><h2><a class="toc-backref" href="#id16">The RPython Typer</a><a class="headerlink" href="#the-rpython-typer" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://bitbucket.org/pypy/pypy/src/default/pypy/rpython/">https://bitbucket.org/pypy/pypy/src/default/pypy/rpython/</a></p>
<p>The RTyper is the first place where the choice of backend makes a
difference; as outlined above we are assuming that ANSI C is the target.</p>
<p>The RPython Typer is the bridge between the <a class="reference internal" href="#annotator">Annotator</a> and the code
generator.  The information computed by the annotator is high-level, in
the sense that it describe RPython types like lists or instances of
user-defined classes.</p>
<p>To emit code we need to represent these high-level annotations in the
low-level model of the target language; for C, this means structures and
pointers and arrays.  The Typer both determines the appropriate low-level type
for each annotation and replaces each high-level operation in the control flow
graphs with one or a few low-level operations.  Just like low-level types,
there is only a fairly restricted set of low-level operations, along the lines
of reading or writing from or to a field of a structure.</p>
<p>In theory, this step is optional; a code generator might be able to read
directly the high-level types.  Our experience, however, suggests that this is
very unlikely to be practical.  &#8220;Compiling&#8221; high-level types into low-level
ones is rather more messy than one would expect and this was the motivation
for making this step explicit and isolated in a single place.  After RTyping,
the graphs only contain operations that already live on the level of the
target language, which makes the job of the code generators much simpler.</p>
<p>For more detailed information, see the <a class="reference external" href="rtyper.html">documentation for the RTyper</a>.</p>
<div class="section" id="example-integer-operations">
<h3><a class="toc-backref" href="#id17">Example: Integer operations</a><a class="headerlink" href="#example-integer-operations" title="Permalink to this headline">¶</a></h3>
<p>Integer operations are make an easy example.  Assume a graph containing the
following operation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">v3</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
</pre></div>
</div>
<p>annotated:</p>
<div class="highlight-python"><pre>v1 -&gt; SomeInteger()
v2 -&gt; SomeInteger()
v3 -&gt; SomeInteger()</pre>
</div>
<p>then obviously we want to type it and replace it with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">v3</span> <span class="o">=</span> <span class="n">int_add</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
</pre></div>
</div>
<p>where &#8211; in C notation &#8211; all three variables v1, v2 and v3 are typed <tt class="docutils literal"><span class="pre">int</span></tt>.
This is done by attaching an attribute <tt class="docutils literal"><span class="pre">concretetype</span></tt> to v1, v2 and v3
(which might be instances of Variable or possibly Constant).  In our model,
this <tt class="docutils literal"><span class="pre">concretetype</span></tt> is <tt class="docutils literal"><span class="pre">pypy.rpython.lltypesystem.lltype.Signed</span></tt>.  Of
course, the purpose of replacing the operation called <tt class="docutils literal"><span class="pre">add</span></tt> with
<tt class="docutils literal"><span class="pre">int_add</span></tt> is that code generators no longer have to worry about what kind
of addition (or concatenation maybe?) it means.</p>
</div>
</div>
<div class="section" id="the-optional-transformations">
<span id="optional-transformations"></span><h2><a class="toc-backref" href="#id18">The Optional Transformations</a><a class="headerlink" href="#the-optional-transformations" title="Permalink to this headline">¶</a></h2>
<p>Between RTyping and C source generation there are two optional transforms:
the &#8220;backend optimizations&#8221; and the &#8220;stackless transform&#8221;. See also
<a class="reference external" href="https://bitbucket.org/pypy/extradoc/raw/ee3059291497/eu-report/D07.1_Massive_Parallelism_and_Translation_Aspects-2007-02-28.pdf">D07.1 Massive Parallelism and Translation Aspects</a> for further details.</p>
<div class="section" id="backend-optimizations">
<h3><a class="toc-backref" href="#id19">Backend Optimizations</a><a class="headerlink" href="#backend-optimizations" title="Permalink to this headline">¶</a></h3>
<p>The point of the backend optimizations are to make the compiled program run
faster.  Compared to many parts of the PyPy translator, which are very unlike
a traditional compiler, most of these will be fairly familiar to people who
know how compilers work.</p>
<div class="section" id="function-inlining">
<h4><a class="toc-backref" href="#id20">Function Inlining</a><a class="headerlink" href="#function-inlining" title="Permalink to this headline">¶</a></h4>
<p>To reduce the overhead of the many function calls that occur when running the
PyPy interpreter we implemented function inlining. This is an optimization
which takes a flow graph and a callsite and inserts a copy of the flow graph
into the graph of the calling function, renaming occurring variables as
appropriate. This leads to problems if the original function was surrounded by
a <tt class="docutils literal"><span class="pre">try:</span> <span class="pre">...</span> <span class="pre">except:</span> <span class="pre">...</span></tt> guard. In this case inlining is not always
possible.  If the called function is not directly raising an exception (but an
exception is potentially raised by further called functions) inlining is safe,
though.</p>
<p>In addition we also implemented heuristics which function to inline where. For
this purpose we assign every function a &#8220;size&#8221;. This size should roughly
correspond to the increase in code-size which is to be expected should the
function be inlined somewhere. This estimate is the sum of two numbers: for
one every operations is assigned a specific weight, the default being a weight
of one. Some operations are considered to be more effort than others,
e.g. memory allocation and calls; others are considered to be no effort at all
(casts...). The size estimate is for one the sum of the weights of all
operations occurring in the graph. This is called the &#8220;static instruction
count&#8221;. The other part of the size estimate of a graph is the &#8220;median
execution cost&#8221;. This is again the sum of the weight of all operations in the
graph, but this time weighted with a guess how often the operation is
executed. To arrive at this guess we assume that at every branch we take both
paths equally often, except for branches that are the end of loops, where the
jump back to the end of the loop is considered more likely.  This leads to a
system of equations which can be solved to get approximate weights for all
operations.</p>
<p>After the size estimate for all function has been determined, functions are
being inlined into their callsites, starting from the smallest functions. Every
time a function is being inlined into another function, the size of the outer
function is recalculated. This is done until the remaining functions all have a
size greater than a predefined limit.</p>
</div>
<div class="section" id="malloc-removal">
<h4><a class="toc-backref" href="#id21">Malloc Removal</a><a class="headerlink" href="#malloc-removal" title="Permalink to this headline">¶</a></h4>
<p>Since RPython is a garbage collected language there is a lot of heap memory
allocation going on all the time, which would either not occur at all in a more
traditional explicitly managed language or results in an object which dies at
a time known in advance and can thus be explicitly deallocated. For example a
loop of the following form:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>which simply iterates over all numbers from 0 to n - 1 is equivalent to the
following in Python:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">l</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="o">...</span>
<span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Which means that three memory allocations are executed: The range object, the
iterator for the range object and the StopIteration instance, which ends the
loop.</p>
<p>After a small bit of inlining all these three objects are never even passed as
arguments to another function and are also not stored into a globally reachable
position. In such a situation the object can be removed (since it would die
anyway after the function returns) and can be replaced by its contained values.</p>
<p>This pattern (an allocated object never leaves the current function and thus
dies after the function returns) occurs quite often, especially after some
inlining has happened. Therefore we implemented an optimization which
&#8220;explodes&#8221; objects and thus saves one allocation in this simple (but quite
common) situation.</p>
</div>
<div class="section" id="escape-analysis-and-stack-allocation">
<h4><a class="toc-backref" href="#id22">Escape Analysis and Stack Allocation</a><a class="headerlink" href="#escape-analysis-and-stack-allocation" title="Permalink to this headline">¶</a></h4>
<p>Another technique to reduce the memory allocation penalty is to use stack
allocation for objects that can be proved not to life longer than the stack
frame they have been allocated in.  This proved not to really gain us any
speed, so over time it was removed again.</p>
</div>
</div>
<div class="section" id="the-stackless-transform">
<h3><a class="toc-backref" href="#id23">The Stackless Transform</a><a class="headerlink" href="#the-stackless-transform" title="Permalink to this headline">¶</a></h3>
<p>The stackless transform converts functions into a form that knows how
to save the execution point and active variables into a heap structure
and resume execution at that point.  This was used to implement
coroutines as an RPython-level feature, which in turn are used to
implement coroutines, greenlets and tasklets as an application
level feature for the Standard Interpreter.</p>
<p>The stackless transformation has been deprecated and is no longer
available in trunk.  It has been replaced with <a class="reference external" href="stackless.html">continulets</a>.</p>
</div>
</div>
<div class="section" id="preparation-for-source-generation">
<span id="preparing-the-graphs-for-source-generation"></span><h2><a class="toc-backref" href="#id24">Preparation for Source Generation</a><a class="headerlink" href="#preparation-for-source-generation" title="Permalink to this headline">¶</a></h2>
<p>This, perhaps slightly vaguely named, stage is the most recent to appear as a
separate step.  Its job is to make the final implementation decisions before
source generation &#8211; experience has shown that you really don&#8217;t want to be
doing <em>any</em> thinking at the same time as actually generating source code.  For
the C backend, this step does three things:</p>
<blockquote>
<div><ul class="simple">
<li>inserts explicit exception handling,</li>
<li>inserts explicit memory management operations,</li>
<li>decides on the names functions and types will have in the final
source (this mapping of objects to names is sometimes referred to as
the &#8220;low-level database&#8221;).</li>
</ul>
</div></blockquote>
<div class="section" id="making-exception-handling-explicit">
<h3><a class="toc-backref" href="#id25">Making Exception Handling Explicit</a><a class="headerlink" href="#making-exception-handling-explicit" title="Permalink to this headline">¶</a></h3>
<p>RPython code is free to use exceptions in much the same way as unrestricted
Python, but the final result is a C program, and C has no concept of
exceptions.  The exception transformer implements exception handling in a
similar way to CPython: exceptions are indicated by special return values and
the current exception is stored in a global data structure.</p>
<p>In a sense the input to the exception transformer is a program in terms of the
<a class="reference external" href="glossary.html#lltypesystem">lltypesystem</a> with exceptions and the output is a program in terms of the bare
lltypesystem.</p>
</div>
<div class="section" id="memory-management-details">
<h3><a class="toc-backref" href="#id26">Memory Management Details</a><a class="headerlink" href="#memory-management-details" title="Permalink to this headline">¶</a></h3>
<p>As well as featuring exceptions, RPython is a garbage collected language;
again, C is not.  To square this circle, decisions about memory management
must be made.  In keeping with PyPy&#8217;s approach to flexibility, there is
freedom to change how to do it.  There are three approaches implemented today:</p>
<blockquote>
<div><ul class="simple">
<li>reference counting (deprecated, too slow)</li>
<li>using the <a class="reference external" href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">Boehm-Demers-Weiser conservative garbage collector</a></li>
<li>using one of our custom <a class="reference external" href="garbage_collection.html">exact GCs implemented in RPython</a></li>
</ul>
</div></blockquote>
<p>Almost all application-level Python code allocates objects at a very fast
rate; this means that the memory management implementation is critical to the
performance of the PyPy interpreter.</p>
<p>You can choose which garbage collection strategy to use with
<a class="reference external" href="config/translation.gc.html">&#8211;gc</a>.</p>
</div>
</div>
<div class="section" id="the-c-back-end">
<span id="c-backend"></span><span id="genc"></span><span id="c"></span><h2><a class="toc-backref" href="#id27">The C Back-End</a><a class="headerlink" href="#the-c-back-end" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://bitbucket.org/pypy/pypy/src/default/pypy/translator/c/">https://bitbucket.org/pypy/pypy/src/default/pypy/translator/c/</a></p>
<p>GenC is usually the most actively maintained backend &#8211; everyone working on
PyPy has a C compiler, for one thing &#8211; and is usually where new features are
implemented first.</p>
</div>
<div class="section" id="a-historical-note">
<h2><a class="toc-backref" href="#id28">A Historical Note</a><a class="headerlink" href="#a-historical-note" title="Permalink to this headline">¶</a></h2>
<p>As this document has shown, the translation step is divided into more
steps than one might at first expect.  It is certainly divided into more
steps than we expected when the project started; the very first version of
GenC operated on the high-level flow graphs and the output of the
annotator, and even the concept of the RTyper didn&#8217;t exist yet.  More
recently, the fact that preparing the graphs for source generation
(&#8220;databasing&#8221;) and actually generating the source are best considered
separately has become clear.</p>
</div>
<div class="section" id="other-backends">
<h2><a class="toc-backref" href="#id29">Other backends</a><a class="headerlink" href="#other-backends" title="Permalink to this headline">¶</a></h2>
<p>Use the <a class="reference external" href="config/translation.backend.html">&#8211;backend</a> option to choose which backend to use.</p>
</div>
<div class="section" id="external-function-calls">
<span id="extfunccalls"></span><h2><a class="toc-backref" href="#id30">External Function Calls</a><a class="headerlink" href="#external-function-calls" title="Permalink to this headline">¶</a></h2>
<p>The external function call approach is described in <a class="reference external" href="rffi.html">rffi</a> documentation.</p>
</div>
<div class="section" id="how-it-fits-together">
<h2><a class="toc-backref" href="#id31">How It Fits Together</a><a class="headerlink" href="#how-it-fits-together" title="Permalink to this headline">¶</a></h2>
<p>As should be clear by now, the translation toolchain of PyPy is a flexible
and complicated beast, formed from many separate components.</p>
<p>The following image summarizes the various parts of the toolchain as of the
0.9 release, with the default translation to C highlighted:</p>
<img alt="_images/pypy-translation-0.9.png" class="align-center" src="_images/pypy-translation-0.9.png" />
<p>A detail that has not yet been emphasized is the interaction of the
various components.  It makes for a nice presentation to say that
after the annotator has finished the RTyper processes the graphs and
then the exception handling is made explicit and so on, but it&#8217;s not
entirely true.  For example, the RTyper inserts calls to many
<a class="reference external" href="glossary.html#low-level-helper">low-level helpers</a> which must first be annotated, and the GC
transformer can use inlining (one of the <a class="reference internal" href="#backend-optimizations">backend optimizations</a>) of
some of its small helper functions to improve performance.  The
following picture attempts to summarize the components involved in
performing each step of the default translation process:</p>
<img alt="_images/translation-detail-0.9.png" class="align-center" src="_images/translation-detail-0.9.png" />
<p>A component not mentioned before is the &#8220;MixLevelAnnotator&#8221;; it
provides a convenient interface for a &#8220;late&#8221; (after RTyping)
translation step to declare that it needs to be able to call each of a
collection of functions (which may refer to each other in a mutually
recursive fashion) and annotate and rtype them all at once.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PyPy - The RPython Toolchain</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#the-flow-model">The Flow Model</a></li>
<li><a class="reference internal" href="#the-annotation-pass">The Annotation Pass</a><ul>
<li><a class="reference internal" href="#mutable-values-and-containers">Mutable Values and Containers</a></li>
<li><a class="reference internal" href="#user-defined-classes-and-instances">User-defined Classes and Instances</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-rpython-typer">The RPython Typer</a><ul>
<li><a class="reference internal" href="#example-integer-operations">Example: Integer operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-optional-transformations">The Optional Transformations</a><ul>
<li><a class="reference internal" href="#backend-optimizations">Backend Optimizations</a><ul>
<li><a class="reference internal" href="#function-inlining">Function Inlining</a></li>
<li><a class="reference internal" href="#malloc-removal">Malloc Removal</a></li>
<li><a class="reference internal" href="#escape-analysis-and-stack-allocation">Escape Analysis and Stack Allocation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-stackless-transform">The Stackless Transform</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preparation-for-source-generation">Preparation for Source Generation</a><ul>
<li><a class="reference internal" href="#making-exception-handling-explicit">Making Exception Handling Explicit</a></li>
<li><a class="reference internal" href="#memory-management-details">Memory Management Details</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-c-back-end">The C Back-End</a></li>
<li><a class="reference internal" href="#a-historical-note">A Historical Note</a></li>
<li><a class="reference internal" href="#other-backends">Other backends</a></li>
<li><a class="reference internal" href="#external-function-calls">External Function Calls</a></li>
<li><a class="reference internal" href="#how-it-fits-together">How It Fits Together</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/translation.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="index.html">PyPy 2.2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, The PyPy Project.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>